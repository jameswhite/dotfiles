#!/bin/bash
# symlink this to ladd, lmod, lsearch, ldel for fast switching


# Create .ldaprc.<domain> files with connection defaults for that domain
# # .ldaprc.github.net
# URI ldaps://ops-ldap.github.net:636
# BASE "dc=github,dc=net"
# BINDDN "uid=jameswhite,ou=People,dc=github,dc=net"
# BINDPW BobLoblaw'sLawBlogBlahblahblah
#

usage(){
case $(basename $0) in
  lsearch)
      echo "Usage:   $(basename $0) [ -v ] [-d <domain> ] <search>"
      echo "Example: $(basename $0) -d github.net cn=hubot"
  ;;
  ladd)
      echo "Usage:   $(basename $0) [ -v ] [ -d <domain> ] [ -f <ldif>]"
      echo "Example: $(basename $0) -d github.net -f jameswhite.ldif"
      echo "Example: cat jameswhite.ldif | $(basename $0) -d github.net"
  ;;
  lmod)
      echo "Usage:   $(basename $0) [ -v ] [ -d <domain> ] [ -f <ldif>]"
      echo "Example: $(basename $0) -d github.net -f jameswhite.ldif"
      echo "Example: cat jameswhite.ldif | $(basename $0) -d github.net"
  ;;
  ldel)
      echo "Usage:   $(basename $0) [ -d <domain> ] <distingushed_name>"
      echo "Example: $(basename $0) -d github.net \"uid=jameswhite,ou=People,dc=github,dc=net\""
  ;;
  lgroups)
      echo "Usage:   $(basename $0) [ -d <domain> ] [ -b base ] <search>"
      echo "Example: $(basename $0) -d github.net -b ou=People,dc=github,dc=net jameswhite"
  ;;
esac
}

SCOPE="sub"
BASEDN_OVERRIDE=""

while [ ! -z "$*" ]; do
  case $1 in
    "-d")
      DOMAIN="$2"
      shift 2
    ;;
    "-b")
      BASEDN_OVERRIDE="$2"
      shift 2
    ;;
    "-s")
      SCOPE_OVERRIDE="$2"
      shift 2
    ;;
    "-f")
      LDIF_FILE="$2"
      shift 2
    ;;
    "-h")
      usage
      exit 0
    ;;
    "-v")
      VERBOSE="TRUE"
      shift 1;
    ;;
    *)
      if [ -z "${ARGS}" ]; then
        ARGS="$1"
      else
        ARGS="${ARGS} $1"
      fi
      shift 1;
    ;;
  esac
done

# dayjob defaults
[ -z "${DOMAIN}" ] && DOMAIN="github.net"


get_value(){
  KEY="$1"
  cat "${HOME}/.ldaprc.${DOMAIN}" | sed -e 's/#.*//' | grep "${KEY}" | sed -e "s/^ *${KEY} *//" -e 's/"//g'
}

if [ -f "${HOME}/.ldaprc.${DOMAIN}" ];then
  URI="$( get_value 'URI' )"
  BASEDN="$( get_value 'BASE' )"
  BINDDN="$( get_value 'BINDDN' )"
  BINDPW="$( get_value 'BINDPW' )"
else
  # Recover if there is no configuration
  # [ -z "$URI" ] && URI="$(dig +short -t srv _ldaps._tcp.${DOMAIN} | sort -n | sed -e 's/\.$//' | awk '{print $4\":\"$3}')"
  [ -z "${URI}" ]    && URI="ldaps://$(hostname -f):636"
  [ -z "${BASE}" ]   && BASE="dc=$(echo ${DOMAIN} | sed -e 's/\./,dc=/g')"
  [ -z "${BINDDN}" ] && BINDDN="cn=admin,${BASE}"
  [ -z "${BINDPW}" ] && BINDPW="$(secret-${DOMAIN})"
fi

[ ! -z "${BASEDN_OVERRIDE}" ] && BASEDN="${BASEDN_OVERRIDE}"
[ ! -z "${SCOPE_OVERRIDE}" ] && SCOPE="${SCOPE_OVERRIDE}"

case $(basename $0) in
  lsearch)
    if [ ! -z "${BINDPW}" ]; then
      if [ "${VERBOSE}" == "TRUE" ]; then
        ldapsearch -E pr=1000/noprompt -xLLLH $URI -b "${BASEDN}" -s "${SCOPE}" -D "${BINDDN}" -w "${BINDPW}" "${ARGS}" '+' '*' | tr "\n" '' | sed -e 's/ //g' | tr '' "\n" | sed -e 's/^#.*//' | grep .
      else
        ldapsearch -E pr=1000/noprompt -xLLLH $URI -b "${BASEDN}" -s "${SCOPE}" -D "${BINDDN}" -w "${BINDPW}" "${ARGS}" | tr "\n" '' | sed -e 's/ //g' | tr '' "\n" | sed -e 's/^#.*//' | grep .
      fi
    else
      if [ "${VERBOSE}" == "TRUE" ]; then
        ldapsearch -E pr=1000/noprompt -xLLLH $URI -b "${BASEDN}" -s "${SCOPE}" -D "${BINDDN}" -W "${ARGS}" '+' '*' | tr "\n" '' | sed -e 's/ //g' | tr '' "\n" | sed -e 's/^#.*//' | grep .
      else
        ldapsearch -E pr=1000/noprompt -xLLLH $URI -b "${BASEDN}" -s "${SCOPE}" -D "${BINDDN}" -W "${ARGS}" | tr "\n" '' | sed -e 's/ //g' | tr '' "\n" | sed -e 's/^#.*//' | grep .
     fi
    fi
  ;;
  ladd)
    if [ -z "${LDIF_FILE}" ]; then
        if [ ! -z "${BINDPW}" ]; then
            cat - | ldapadd -xH $URI -D "${BINDDN}" -w "${BINDPW}"
        else
            cat - | ldapadd -xH $URI -D "${BINDDN}" -W
        fi
    else
        if [ ! -z "${BINDPW}" ]; then
            ldapadd -xH $URI -D "${BINDDN}" -w "${BINDPW}" -f "${LDIF_FILE}"
        else
            ldapadd -xH $URI -D "${BINDDN}" -W -f "${LDIF_FILE}"
        fi
    fi
  ;;
  lmod)
    if [ -z "${LDIF_FILE}" ]; then
        if [ ! -z "${BINDPW}" ]; then
            cat - | ldapmodify -xH $URI -D "${BINDDN}" -w "${BINDPW}"
        else
            cat - | ldapmodify -xH $URI -D "${BINDDN}" -W
        fi
    else
        if [ ! -z "${BINDPW}" ]; then
            ldapmodify -xH $URI -D "${BINDDN}" -w "${BINDPW}" -f "${LDIF_FILE}"
        else
            ldapmodify -xH $URI -D "${BINDDN}" -W -f "${LDIF_FILE}"
        fi
    fi
  ;;
  ldel)
    if [ ! -z "${BINDPW}" ]; then
        ldapdelete -xH ${URI} -D "${BINDDN}" -w "${BINDPW}" $*
    else
        ldapdelete -xH ${URI} -D "${BINDDN}" -W $*
    fi
  ;;
  lgroups)
    if [ ! -z "${BINDPW}" ]; then
        ldapsearch -E pr=1000/noprompt -xLLLH $URI -b "${BASEDN}" -s "${SCOPE}" -D "${BINDDN}" -w "${BINDPW}" "uniqueMember=uid=${ARGS},ou=People,${BASEDN}" | tr "\n" '' | sed -e 's/ //g' | tr '' "\n" | sed -e 's/^#.*//' | grep "^dn: " | sed -e 's/^dn: //' | sed -e 's/,ou=[Gg]roups,dc=github,dc=net//g'
    fi

  ;;
esac
